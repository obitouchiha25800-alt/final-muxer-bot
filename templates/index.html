<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AD Web Muxer</title>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 15px; margin: 0; text-align: center; }
        h1 { font-size: 1.5rem; margin-bottom: 20px; color: #58a6ff; }
        .box { background: #161b22; padding: 15px; border: 1px solid #30363d; border-radius: 12px; margin-bottom: 20px; }
        
        input, select { 
            width: 100%; padding: 12px; margin: 8px 0; 
            background: #0d1117; color: white; border: 1px solid #30363d; 
            border-radius: 8px; font-size: 16px; box-sizing: border-box; 
        }
        
        button { width: 100%; padding: 14px; margin-top: 10px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; }
        
        /* --- BUTTON COLORS --- */
        .btn-green { background: #238636; color: white; transition: 0.3s; }
        
        /* Refresh Button (Small & Blue) */
        .btn-blue { 
            background: #1f6feb; color: white; transition: 0.3s; 
            font-size: 14px; padding: 6px 12px; 
        } 
        
        /* Upload Font Button (Small, Grey & Subtle) */
        .btn-grey { 
            background: #21262d; /* Dark Grey */
            color: #c9d1d9; 
            border: 1px solid #30363d; 
            font-size: 14px; /* Chhota Text */
            padding: 8px 15px; /* Chhota Size */
            transition: 0.2s;
        }
        .btn-grey:hover { border-color: #8b949e; }
        
        .actions { display: flex; gap: 8px; margin-top: 10px; }
        .btn-dl { background: #238636; color: white; text-decoration: none; padding: 10px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; flex-grow: 2; text-align: center; display: flex; align-items: center; justify-content: center; }
        .btn-copy { background: #1f6feb; color: white; border: none; padding: 10px; border-radius: 6px; font-size: 1.2rem; cursor: pointer; flex-grow: 1; margin-top: 0; }
        .btn-del { background: transparent; border: 1px solid #da3633; color: #da3633; padding: 10px; border-radius: 6px; font-size: 1.2rem; cursor: pointer; flex-grow: 0; margin-top: 0; }

        .file-item { background: #21262d; margin-top: 12px; padding: 15px; border-radius: 8px; border: 1px solid #30363d; text-align: left; }
        .file-name { font-weight: bold; word-break: break-all; color: #e6edf3; font-size: 0.95rem; }
        
        .progress-container { background: #333; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .progress-bar { height: 100%; background: #238636; width: 0%; transition: width 0.3s; }
        .status-text { font-size: 0.85rem; color: #e3b341; margin-bottom: 5px;}
    </style>
    <script>
        let intervalId;

        function updateProgress() {
            document.querySelectorAll('.processing').forEach(div => {
                let filename = div.getAttribute('data-name');
                fetch('/progress/' + filename + '?t=' + new Date().getTime())
                .then(r => r.json())
                .then(d => {
                    div.querySelector('.progress-bar').style.width = d.percent + "%";
                    if(d.percent >= 100) {
                        clearInterval(intervalId);
                        div.querySelector('.status-text').innerText = "‚úÖ Finalizing...";
                        div.querySelector('.status-text').style.color = "#39d353";
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        div.querySelector('.status-text').innerText = d.status;
                    }
                }).catch(e => console.log("Waiting..."));
            });
        }
        
        function copyLink(filename) {
            const link = window.location.origin + "/downloads/" + filename;
            navigator.clipboard.writeText(link).then(() => { alert("‚úÖ Link Copied!"); }).catch(err => { prompt("Copy Link:", link); });
        }
        
        intervalId = setInterval(updateProgress, 1500);
    </script>
</head>
<body>
    <h1>üöÄ AD Web Muxer</h1>
    
    <div class="box">
        <form action="/mux" method="POST" enctype="multipart/form-data" onsubmit="document.querySelector('.btn-green').innerText='‚è≥ Starting...'; document.querySelector('.btn-green').style.opacity='0.7';">
            <input type="text" name="video_url" placeholder="Paste M3U8 Link" required>
            <input type="file" name="subtitle" required>
            <select name="font">
                <option value="NONE">Default Font</option>
                {% for font in fonts %}<option value="{{ font }}">{{ font }}</option>{% endfor %}
            </select>
            <input type="text" name="filename" placeholder="Output Filename (e.g. Episode 1)" required>
            <button type="submit" class="btn-green">Start Muxing</button>
        </form>
        
        <hr style="border-color: #30363d; margin: 15px 0;">
        
        <form action="/upload_font" method="POST" enctype="multipart/form-data" style="display:flex; gap:10px; align-items:center;">
            <input type="file" name="font_file" accept=".ttf,.otf" style="flex:1; margin:0;">
            <button type="submit" class="btn-grey" style="width:auto; margin:0;">Upload Font</button>
        </form>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0;">üìÇ Files</h3>
        <button onclick="location.reload()" class="btn-blue" style="width:auto; margin:0;">Refresh</button>
    </div>

    <div>
        {% for file in files %}
            <div class="file-item {% if 'RUNNING_' in file.real_name %}processing{% endif %}" data-name="{{ file.real_name }}">
                <div class="file-name">{{ file.display_name }}</div>
                
                {% if 'RUNNING_' in file.real_name %}
                    <div style="margin-top:10px;">
                        <div class="status-text">‚è≥ Initializing...</div>
                        <div class="progress-container"><div class="progress-bar"></div></div>
                    </div>
                {% else %}
                    <div class="actions">
                        <a href="/downloads/{{ file.real_name }}" class="btn-dl">‚¨áÔ∏è Download</a>
                        <button onclick="copyLink('{{ file.real_name }}')" class="btn-copy">üìã</button>
                        <a href="/delete/{{ file.real_name }}" class="btn-del">üóëÔ∏è</a>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <p style="color:#8b949e; margin-top: 20px;">No files yet.</p>
        {% endfor %}
    </div>
</body>
</html>
